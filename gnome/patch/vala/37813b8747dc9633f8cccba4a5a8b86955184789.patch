From 37813b8747dc9633f8cccba4a5a8b86955184789 Mon Sep 17 00:00:00 2001
From: Chris White <cxwembedded@gmail.com>
Date: Mon, 22 Jun 2020 08:28:29 -0400
Subject: [PATCH] Retrieve version when in a git worktree

- Change git-version-gen invocation to match tag format
- Use autoconf to make vala/valaversion.vala rather than generating that
  file by hand
---
 Makefile.am      |  2 +-
 configure.ac     |  9 +++++----
 vala/Makefile.am | 12 ++----------
 3 files changed, 8 insertions(+), 15 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index f70234759..1bfbe80a7 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -68,7 +68,7 @@ $(top_srcdir)/.version: gen-version
 	@true
 .PHONY: gen-version
 gen-version:
-	@V=`$(top_srcdir)/build-aux/git-version-gen $(top_srcdir)/.tarball-version` &&			\
+	@V=`$(top_srcdir)/build-aux/git-version-gen --prefix '' $(top_srcdir)/.tarball-version` &&			\
 	if [ -e $(top_srcdir)/.version ] && [ "x`cat $(top_srcdir)/.version`" = "x$$V" ]; then		\
 	  true;												\
 	else												\
diff --git a/configure.ac b/configure.ac
index 097a324df..b3caa0373 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1,5 +1,5 @@
 AC_PREREQ([2.65])
-AC_INIT([vala], m4_esyscmd([build-aux/git-version-gen .tarball-version]),
+AC_INIT([vala], m4_esyscmd([build-aux/git-version-gen --prefix '' .tarball-version]),
 	[https://gitlab.gnome.org/GNOME/vala/issues],
 	[vala],
 	[https://wiki.gnome.org/Projects/Vala])
@@ -16,9 +16,9 @@ PACKAGE_SUFFIX="-$API_VERSION"
 VALA_MAJOR_VERSION=`echo $PACKAGE_VERSION | cut -d. -f1 | sed s/[[a-zA-Z\-]].*//g`
 VALA_MINOR_VERSION=`echo $PACKAGE_VERSION | cut -d. -f2 | sed s/[[a-zA-Z\-]].*//g`
 VALA_MICRO_VERSION=`echo $PACKAGE_VERSION | cut -d. -f3 | sed s/[[a-zA-Z\-]].*//g`
-AC_SUBST(VALA_MAJOR_VERSION)
-AC_SUBST(VALA_MINOR_VERSION)
-AC_SUBST(VALA_MICRO_VERSION)
+AC_SUBST([VALA_MAJOR_VERSION])
+AC_SUBST([VALA_MINOR_VERSION])
+AC_SUBST([VALA_MICRO_VERSION])
 
 dnl http://people.gnome.org/~walters/docs/build-api.txt
 dnl We don't support separate builddir when building from git
@@ -224,6 +224,7 @@ AC_CONFIG_FILES([Makefile
            gee/Makefile
            ccode/Makefile
            vala/Makefile
+           vala/valaversion.vala
            codegen/Makefile
            compiler/Makefile
            vapi/Makefile
diff --git a/vala/Makefile.am b/vala/Makefile.am
index 0191fc9aa..af48bbf0c 100644
--- a/vala/Makefile.am
+++ b/vala/Makefile.am
@@ -11,15 +11,7 @@ AM_CPPFLAGS = \
 	-DPACKAGE_DATADIR=\"$(pkgdatadir)\" \
 	$(NULL)
 
-BUILT_SOURCES = vala.vala.stamp $(srcdir)/valaversion.vala
-
-$(srcdir)/valaversion.vala:
-	sed -e "s#\@VALA_MAJOR_VERSION\@#$(VALA_MAJOR_VERSION)#g" \
-		-e "s#\@VALA_MINOR_VERSION\@#$(VALA_MINOR_VERSION)#g" \
-		-e "s#\@VALA_MICRO_VERSION\@#$(VALA_MICRO_VERSION)#g" \
-		-e "s#\@API_VERSION\@#$(API_VERSION)#g" \
-		-e "s#\@PACKAGE_VERSION\@#$(PACKAGE_VERSION)#g" \
-		< $@.in > $@
+BUILT_SOURCES = vala.vala.stamp
 
 lib_LTLIBRARIES = \
 	libvala@PACKAGE_SUFFIX@.la \
@@ -229,7 +221,7 @@ dist_vapi_DATA = libvala@PACKAGE_SUFFIX@.vapi
 libvala@PACKAGE_SUFFIX@.vapi: $(top_srcdir)/gee/gee.vapi $(top_srcdir)/vala/vala.vapi
 	cat $^ > $@
 
-EXTRA_DIST = $(libvala_la_VALASOURCES) vala.vapi vala.vala.stamp vala.h valaversion.vala.in
+EXTRA_DIST = $(libvala_la_VALASOURCES) vala.vapi vala.vala.stamp vala.h
 
 MAINTAINERCLEANFILES = \
 	vala.vapi \
-- 
GitLab

